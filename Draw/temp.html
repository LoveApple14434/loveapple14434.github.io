
<div class="pixel-art-container">
  <!-- 颜色选择工具栏 -->
  <div class="color-toolbar">
    <div class="container-color">
      <input type="color" id="color-input" class="input-color">
    </div>
    <div class="preset-colors">
      <div class="preset" style="background-color: #FF0000"></div>
      <div class="preset" style="background-color: #00FF00"></div>
      <div class="preset" style="background-color: #0000FF"></div>
      <div class="preset" style="background-color: #FFFF00"></div>
      <div class="preset" style="background-color: #FF00FF"></div>
      <div class="preset" style="background-color: #00FFFF"></div>
      <div class="preset" style="background-color: #000000"></div>
      <div class="preset" style="background-color: #FFFFFF"></div>
      <div class="preset" style="background-color: #364A89"></div>
      <div class="preset" style="background-color: #06ABE3"></div>
    </div>
  </div>

  <!-- 8x8像素网格 -->
  <form id="pixel-form">
    <div class="pixel-grid" id="pixel-grid">
      <!-- 网格将由JS动态生成 -->
    </div>
    <div class="form-controls">
      <div class="input-box">
        <label for="UserID" style="margin:auto 0 auto auto; color: white;">User ID:</label>
        <input type="text" id="UserID" placeholder="如需上传则必填" name="UserID" class="input-text">
      </div>
      <div class="input-box">
        <label for="ArtworkID" style="margin:auto 0 auto auto; color: white;">Artwork ID:</label>
        <input type="text" id="ArtworkID" placeholder="如需上传则必填" name="ArtWorkID" class="input-text">
      </div>
    </div>
    <div class="form-controls">
      <button type="button" id="clear-btn">清除画板</button>
      <button type="submit" id="submit-btn">上传作品</button>
    </div>
  </form>
  
  <div id="response-message"></div>
</div>

<style>
.container-color {
  position: relative;
  width: 120px;
  height: 120px;
  margin: auto;
}
.input-color{
  position: relative;
  display: flex;
  width: 100px;
  height: 100px;
  margin: auto;
}

.input-box{
  display: inline-block;
  margin: 0 auto;
  flex-wrap: wrap;
}

.input-text{
  min-width: 120px;
  margin: auto;
  height: 30px;

}

.pixel-art-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  background-color: #2c3e50;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.color-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 15px;
  background-color: #34495e;
  border-radius: 8px;
  margin-bottom: 25px;
}

.color-picker {
  flex: 1;
  min-width: 250px;
}

.color-picker label {
  display: inline-block;
  width: 30px;
  color: #ecf0f1;
  font-weight: bold;
}

.color-picker input[type="range"] {
  width: 120px;
  margin-right: 10px;
}

.color-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 100px;
}

#current-color {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 3px solid #ecf0f1;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
}

#color-hex {
  margin-top: 10px;
  color: #ecf0f1;
  font-weight: bold;
  font-family: monospace;
}

.preset-colors {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  max-width: 200px;
  margin: auto;
}

.preset {
  width: 30px;
  height: 30px;
  border-radius: 4px;
  cursor: pointer;
  border: 2px solid #7f8c8d;
  transition: transform 0.2s;
}

.preset:hover {
  transform: scale(1.2);
  border-color: #ecf0f1;
}

.pixel-grid {
  display: grid;
  grid-template-columns: repeat(16, 1fr);
  grid-gap: 2px;
  /* width: 300px;
  height: 300px; */
  margin: 0 auto;
  background-color: #7f8c8d;
  border: 4px solid #34495e;
  border-radius: 4px;
  padding: 5px;
}
@media screen and (min-width: 801px) {.pixel-grid{width: 600px; height: 600px;}}
@media screen and (max-width: 800px) {.pixel-grid{width: 300px; height: 300px;}}

.pixel {
  background-color: #ecf0f1;
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.1s;
}

.pixel:hover {
  opacity: 0.8;
  transform: scale(1.05);
}

.form-controls {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 25px;
}

button {
  padding: 12px 30px;
  border: none;
  border-radius: 30px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

#clear-btn {
  background-color: #e74c3c;
  color: white;
}

#clear-btn:hover {
  background-color: #c0392b;
}

#submit-btn {
  background-color: #2ecc71;
  color: white;
}

#submit-btn:hover {
  background-color: #27ae60;
}

#response-message {
  margin-top: 20px;
  padding: 15px;
  text-align: center;
  font-size: 16px;
  border-radius: 5px;
  display: none;
}

.success-message {
  background-color: #d4edda;
  color: #155724;
  display: block !important;
}

.error-message {
  background-color: #f8d7da;
  color: #721c24;
  display: block !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 当前选中的颜色
  let currentColor = { r: 200, g: 100, b: 50 };
  
  // 获取DOM元素
  const redSlider = document.getElementById('red');
  const greenSlider = document.getElementById('green');
  const blueSlider = document.getElementById('blue');
  const redValue = document.getElementById('red-value');
  const greenValue = document.getElementById('green-value');
  const blueValue = document.getElementById('blue-value');
  const currentColorDiv = document.getElementById('current-color');
  const colorHex = document.getElementById('color-hex');
  const pixelGrid = document.getElementById('pixel-grid');
  const presetColors = document.querySelectorAll('.preset');
  const clearBtn = document.getElementById('clear-btn');
  const submitBtn = document.getElementById('submit-btn');
  const pixelForm = document.getElementById('pixel-form');
  const responseMessage = document.getElementById('response-message');
  // const colorInput = document.querySelector("color-input")
  let colorInput;
  colorInput = document.querySelector("#color-input");
  colorInput.value = "#c86432";

  
  // 初始化网格
  function initPixelGrid() {
    pixelGrid.innerHTML = '';
    
    for (let i = 0; i < 16*16; i++) {
      const pixel = document.createElement('div');
      pixel.className = 'pixel';
      pixel.dataset.index = i;
      
      pixel.addEventListener('click', () => {
        const rgb = `rgb(${currentColor.r}, ${currentColor.g}, ${currentColor.b})`;
        pixel.style.backgroundColor = rgb;
        pixel.dataset.color = rgb;
      });
      
      pixelGrid.appendChild(pixel);
    }
  }
  
  // 更新颜色预览
  function updateColorPreview() {
    colorInput.value = rgbToHex(currentColor.r, currentColor.g, currentColor.b);
  }
  
  // RGB转十六进制
  function rgbToHex(r, g, b) {
    return '#' + [r, g, b].map(x => {
      const hex = x.toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }).join('').toUpperCase();
  }

  function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

// alert(hexToRgb("#0033ff").g); // "51";

  colorInput.addEventListener('change', () =>{
    currentColor = hexToRgb(colorInput.value);
    console.log(currentColor);
    updateColorPreview();
  })
  
  // 预设颜色点击事件
  presetColors.forEach(preset => {
    preset.addEventListener('click', () => {
      const color = getComputedStyle(preset).backgroundColor;
      const rgb = color.match(/\d+/g);
      
      if (rgb && rgb.length >= 3) {
        currentColor.r = parseInt(rgb[0]);
        currentColor.g = parseInt(rgb[1]);
        currentColor.b = parseInt(rgb[2]);
        
        updateColorPreview();
      }
    });
  });
  
  // 清除画板
  clearBtn.addEventListener('click', () => {
    const pixels = document.querySelectorAll('.pixel');
    pixels.forEach(pixel => {
      pixel.style.backgroundColor = '';
      pixel.removeAttribute('data-color');
    });
  });
  
  // 表单提交
  pixelForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 收集像素数据
    const pixels = document.querySelectorAll('.pixel');
    const pixelData = [];
    
    pixels.forEach(pixel => {
      if (pixel.dataset.color) {
        pixelData.push(pixel.dataset.color);
      } else {
        pixelData.push('transparent');
      }
    });

      let userID;
      userID = document.querySelector("#UserID");
      let artworkID;
      artworkID = document.querySelector("#ArtworkID");

    // 创建数据对象
    const data = {
      artwork: pixelData,
      createdAt: new Date().toISOString(),
      colorCount: pixelData.filter(color => color !== 'transparent').length,
      UID: userID.value,
      ID: artworkID.value
    };
    
    try {
      // 发送到后端
      const response = await fetch('http://api.loveapple.icu/api/save-artwork', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (response.ok) {
        showResponse('作品已成功保存！', 'success');
      } else {
        showResponse(`保存失败: ${result.message}`, 'error');
      }
    } catch (error) {
      showResponse(`网络错误: ${error.message}`, 'error');
    }
  });
  
  // 显示响应消息
  function showResponse(message, type) {
    responseMessage.textContent = message;
    responseMessage.className = type === 'success' ? 
      'success-message' : 'error-message';
    
    // 3秒后自动隐藏
    setTimeout(() => {
      responseMessage.style.display = 'none';
    }, 3000);
  }
  
  // 初始化
  initPixelGrid();
  updateColorPreview();
});
</script>